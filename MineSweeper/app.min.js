const gameTableHTML=document.getElementById("game-table"),modeSelect=document.getElementById("mode-setting"),newCellClassName="new-cell",cellIDName="game-cell-id-",flagClassName="cell-flag",setupGame=()=>{CONFIG.currentMode=modeSelect.value;const e=getCurrentGameMode(),t=e.bombs,l=e.size,a=l.rows,n=l.cols,m=[];let r,s,o,i,c,g,d,b,u=1e4;for(;m.length<t&&u>0;)r=Math.floor(Math.random()*(a*n))+1,-1==m.indexOf(r)&&m.push(r),u--;for(CONFIG.bombLocations=m,gameTableHTML.innerHTML="",s=0;s<a;s++)for(o=gameTableHTML.insertRow(s),j=1;j<=n;j++)(i=o.insertCell(j-1)).classList.add("new-cell"),i.setAttribute("row",s),i.setAttribute("col",j),c=makeCellID(s,j),i.id=cellIDName+c,b="",m.indexOf(c)>-1?(b="X",i.setAttribute("hasBomb",1)):(g=0,getCellIDsAround(s,j).map(e=>{m.indexOf(e)>-1&&g++}),g&&(b=g),i.setAttribute("bombsAroundCell",g)),(d=document.createElement("span")).classList.add("cell-content"),d.innerHTML=b,i.appendChild(d);CONFIG.gamePlayable=!0,setBombsRemaining(),timerControl("start")},getCellIDsAround=(e,t)=>{const l=getCurrentGameMode(),a=l.size.rows,n=l.size.cols,m=e+2,r=t+2,s=[];let o,i,c;for(o=e-1;o<m;o++)for(i=t-1;i<r;i++)c=makeCellID(o,i),o<a&&i>0&&i<=n&&makeCellID(e,t)!=c&&s.push(c);return s},makeCellID=(e,t)=>(gameMode=getCurrentGameMode(),e*gameMode.size.cols+t),getCurrentGameMode=()=>CONFIG.mode[CONFIG.currentMode],newCellClicked=(e,t)=>{const l=parseInt(e.getAttribute("row"),10),a=parseInt(e.getAttribute("col"),10),n=1==parseInt(e.getAttribute("hasBomb"),10),m=parseInt(e.getAttribute("bombsAroundCell"),10);if(1==t){const t=1==parseInt(e.getAttribute("markedAsBomb"),10);if(e.setAttribute("markedAsBomb",t?0:1),t){const t=e.getElementsByClassName("cell-flag");e.removeChild(t[0])}else{const t=document.createElement("img");t.setAttribute("src","images/flag.png"),t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("alt","flag"),t.classList.add("cell-flag"),e.appendChild(t),e.setAttribute("hasFlag",1)}setBombsRemaining()}else{if(n){let e,t;return timerControl(),alert("DEAD"),CONFIG.bombLocations.map(l=>{e=document.getElementById(cellIDName+l),(t=document.createElement("img")).setAttribute("src","images/bomb.png"),t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("alt","bomb"),t.classList.add("cell-flag"),e.innerHTML="",e.appendChild(t),e.setAttribute("hasFlag",0)}),void(CONFIG.gamePlayable=!1)}if(e.classList.remove("new-cell"),0==m){let e;getCellIDsAround(l,a).map(t=>{(e=document.getElementById(cellIDName+t))&&e.matches(".new-cell")&&1!=parseInt(e.getAttribute("hasFlag"),10)&&newCellClicked(e)})}}const r=CONFIG.bombLocations,s=currentMarkedBombs();if(unclickCells=gameTableHTML.getElementsByClassName("new-cell").length-gameTableHTML.getElementsByClassName("cell-flag").length,0===unclickCells&&r.length===s.length){let e=0;s.map(t=>{r.indexOf(t)>-1&&e++}),e===r.length&&(alert("GAME WON"),timerControl(),CONFIG.gamePlayable=!1)}},currentMarkedBombs=()=>{const e=gameTableHTML.getElementsByClassName("cell-flag"),t=e.length;let l,a,n=[];for(l=0;l<t;l++)a=e[l].parentNode,n.push(makeCellID(parseInt(a.getAttribute("row"),10),parseInt(a.getAttribute("col"),10)));return n},setBombsRemaining=()=>{document.getElementById("game-bombs-remaining").innerHTML=CONFIG.bombLocations.length-currentMarkedBombs().length},timerHTML=document.getElementById("game-timer");let timerInterval;const timerControl=e=>{clearInterval(timerInterval),timerTime=0,"start"==e&&(timerInterval=setInterval(()=>{timerTime++,timerHTML.innerHTML=timerTime},1e3))};(()=>{let e;Object.keys(CONFIG.mode).forEach(t=>{(e=document.createElement("option")).value=t,e.text=CONFIG.mode[t].name,modeSelect.add(e)}),setupGame(),gameTableHTML.onmousedown=(e=>{if(e=e||window.event,!CONFIG.gamePlayable)return;let t,l,a=e.target;"which"in e?t=3==e.which:"button"in e&&(t=2==e.button),(l=a.matches(".cell-flag")&&t)&&(a=a.parentNode),(a.matches(".new-cell")||l)&&newCellClicked(a,t)}),gameTableHTML.oncontextmenu=(()=>!1)})();